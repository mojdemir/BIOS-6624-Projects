

```{r}
 #============================================================
# BIOS6624 Project 1 - Script 02: Frequentist Models + Tables
# Purpose:
#   - Load processed wide dataset (from Script 01)
#   - Fit core models (total effect; no adherence)
#   - Produce a results table (estimate, CI, p-value) for exposure
# Outputs:
#   - results/tables/frequentist_core_results.csv
# ============================================================

library(tidyverse)
library(lmtest)
library(sandwich)

processed_path <- "C:/Users/mojde/Desktop/Documents/Projects/Project1/DataProcessed/df_year2_wide.rds"
results_tbl    <- "C:/Users/mojde/Desktop/Documents/Projects/Project1/Results/Tables"

df_wide <- readRDS(processed_path)

```


vars <- c("HardDrugUse_baseline","logVLOAD_baseline","Age_baseline","RACE_baseline",
          "EDU_baseline","Income_baseline","Smoke_baseline","Alcohol_baseline","logCESD_baseline")

sapply(df_wide[vars], function(x) {
  if (is.factor(x) || is.character(x)) length(unique(na.omit(x))) else NA
})
table(df_wide$HardDrugUse_baseline, useNA = "ifany")



```{r}
# ---- Fit core models (no adherence; adherence is a mediator) ----
m_vl_core <- lm(
  logVLOAD_year2 ~ HardDrugUse_baseline + logVLOAD_baseline +
    Age_baseline + RACE_baseline + EDU_baseline + Income_baseline +
    Smoke_baseline + Alcohol_baseline + logCESD_baseline,
  data = df_wide
)

m_cd4_core <- lm(
  logCD4_year2 ~ HardDrugUse_baseline + logCD4_baseline +
    Age_baseline + RACE_baseline + EDU_baseline + Income_baseline +
    Smoke_baseline + Alcohol_baseline + logCESD_baseline,
  data = df_wide
)

m_phys_core <- lm(
  PHYS_year2 ~ HardDrugUse_baseline + PHYS_baseline +
    Age_baseline + RACE_baseline + EDU_baseline + Income_baseline +
    Smoke_baseline + Alcohol_baseline + logCESD_baseline,
  data = df_wide
)

m_ment_core <- lm(
  MENT_year2 ~ HardDrugUse_baseline + MENT_baseline +
    Age_baseline + RACE_baseline + EDU_baseline + Income_baseline +
    Smoke_baseline + Alcohol_baseline + logCESD_baseline,
  data = df_wide
)

```



```{r}
# ---- Helper to extract robust estimate + CI + p-value for exposure ----
get_robust_row <- function(model, outcome_label) {
  ct <- lmtest::coeftest(model, vcov = sandwich::vcovHC(model, type = "HC3"))
  est <- ct["HardDrugUse_baselineYes", "Estimate"]
  se  <- ct["HardDrugUse_baselineYes", "Std. Error"]
  p   <- ct["HardDrugUse_baselineYes", "Pr(>|t|)"]

  # 95% CI using normal approximation (simple + common)
  lo <- est - 1.96 * se
  hi <- est + 1.96 * se

  data.frame(
    outcome = outcome_label,
    estimate = est,
    se_robust = se,
    ci_low = lo,
    ci_high = hi,
    p_value = p
  )
}
```



```{r}
# ---- Build results table for the exposure effect ----
freq_table <- bind_rows(
  get_robust_row(m_vl_core,  "logVLOAD (Year 2)"),
  get_robust_row(m_cd4_core, "logCD4 (Year 2)"),
  get_robust_row(m_phys_core, "AGG_PHYS (Year 2)"),
  get_robust_row(m_ment_core, "AGG_MENT (Year 2)")
)
```



```{r}
freq_table
write.csv(freq_table, file.path(results_tbl, "frequentist_core_results.csv"), row.names = FALSE)
```
